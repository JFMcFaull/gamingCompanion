<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Details</title>
    <link rel="stylesheet" href="gameDetails.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
</head>
<body>

<div id="header" class="header">
    <a href="gamesLibrary.html" class="header-button back-button">Back</a>
    <div class="header-buttons">
        <button id="deleteButton" class="header-button" onclick="openModal()">Game Over?</button>
        <button id="editButton" class="header-button" onclick="openUpdatePage()">Edit Game</button>
    </div>
</div>

<div class="container">
    <h1 id="gameTitle">Loading Game...</h1>
    <div id="gameDetails">
    </div>
</div>

<div id="myModal" class="modal">
    <div class="modal-content">
        <p>Are you sure you want to delete this game?</p>
        <button class="modal-button confirm-btn" onclick="deleteGame()">Yes, Delete</button>
        <button class="modal-button cancel-btn" onclick="closeModal()">Cancel</button>
    </div>
</div>

<script>
    async function fetchGameDetails() {
        try {
            // Extract url parameter
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('id');

            // Fetch game details from the API
            const response = await fetch(`http://localhost:8080/games/${gameId}`);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const gameData = await response.json();

            // Call displayGameDetails function with the fetched data
            displayGameDetails(gameData);

        } catch (error) {
            console.error('Error fetching game details:', error);
            // Handle the error appropriately
        }
    }

    function displayGameDetails(gameData) {
        const gameDetailsContainer = document.getElementById('gameDetails');
        const deleteButton = document.getElementById('deleteButton');
        const editButton = document.getElementById('editButton');

        // Gather game details
        const game = gameData.game;
        const title = game.Title ? game.Title : 'Unknown Title';
        const franchise = game.Franchise ? game.Franchise : 'Unknown Franchise';
        const platformText = game.Platform ? game.Platform : 'Unknown';
        const mainQuests = parseInt(game.MainQuests);
        const completedMainQuests = parseInt(game.CompletedMainQuests);
        const sideQuests = parseInt(game.SideQuests);
        const completedSideQuests = parseInt(game.CompletedSideQuests);
        const collectibles = parseInt(game.Collectibles);
        const collectedCollectibles = parseInt(game.CollectedCollectibles);
        const currentlyPlaying = game.CurrentlyPlaying !== undefined ? game.CurrentlyPlaying : false;

        // Retrieve game guide and game map links
        const gameGuide = game.GameGuide ? game.GameGuide : null;
        const gameMap = game.GameMap ? game.GameMap : null;

        // Calculate total counts and completed counts
        const totalQuests = mainQuests + sideQuests;
        const completedQuests = completedMainQuests + sideQuests;

        // Calculate overall completion percentages
        const questsPercentage = totalQuests > 0 ? (completedMainQuests / mainQuests) * 100 : 0;
        const collectiblesPercentage = collectibles > 0 ? (collectedCollectibles / collectibles) * 100 : 0;
        const sideQuestsPercentage = sideQuests > 0 ? (completedSideQuests / sideQuests) * 100 : 0;

        // Calculate total completion percentage
        const totalCompletionPercentage = ((completedMainQuests + collectedCollectibles) / (mainQuests + collectibles)) * 100;

        // Calculate completion percentage text
        const completionPercentageText = `Completion: ${totalCompletionPercentage.toFixed(2)}%`;

        // Determine image based on total completion percentage
        let imageSrc = '';
        if (totalCompletionPercentage >= 80) {
            imageSrc = 'Assets/Hearts/Hundred.png'; // Image for 80-100%
        } else if (totalCompletionPercentage >= 60) {
            imageSrc = 'Assets/Hearts/Eighty.png'; // Image for 60-79%
        } else if (totalCompletionPercentage >= 40) {
            imageSrc = 'Assets/Hearts/Sixty.png'; // Image for 40-59%
        } else if (totalCompletionPercentage >= 20) {
            imageSrc = 'Assets/Hearts/Forty.png'; // Image for 20-39%
        } else {
            imageSrc = 'Assets/Hearts/Zero.png'; // Image for 0-19% (assuming this range)
        }

        // Update the dynamic title
        document.getElementById('gameTitle').textContent = title;

        // Construct the HTML for displaying game details
        const gameHTML = `
            <div class="game-overview">
                <div class="game-details">

                    <div class="game-details-info">
                        <h2>Game Details:</h2>
                        <p>Title: ${title}</p>
                        <p>Franchise: ${franchise}</p>
                        <p>Platform: ${platformText}</p>
                        <p>Playing Status: ${getCurrentlyPlayingText(currentlyPlaying)}</p>
                    </div>

                    <div class="game-info">
                        <h2>Game Progress:</h2>
                        <p>Main Quests: ${completedMainQuests}/${mainQuests} (${questsPercentage.toFixed(2)}%)</p>
                        <p>Side Quests: ${completedSideQuests}/${sideQuests} (${sideQuestsPercentage.toFixed(2)}%)</p>
                        <p>Collectibles: ${collectedCollectibles}/${collectibles} (${collectiblesPercentage.toFixed(2)}%)</p>
                        <p>Total Completed: ${totalCompletionPercentage.toFixed(2)}%</p>
                        <img src="${imageSrc}" alt="Completion Image" class="hearts">
                    </div>
                    
                    <div class="game-support">
                        <h2>Game Support:</h2>
                        ${gameGuide ? `<p><a href="${gameGuide}" target="_blank">Game Guide</a></p>` : ''}
                        ${gameMap ? `<p><a href="${gameMap}" target="_blank">Game Map</a></p>` : ''}
                    </div>
                </div>
            </div>
        `;

        // Insert the HTML into the game details container
        gameDetailsContainer.innerHTML = gameHTML;

        // Display the delete and edit buttons
        deleteButton.style.display = 'block';
        editButton.style.display = 'block';

    }

    function getCurrentlyPlayingText(currentlyPlaying) {
        switch (currentlyPlaying) {
            case 'Currently Playing':
                return 'Currently Playing';
            case 'Paused':
                return 'Paused';
            case 'Completed':
                return 'Completed';
            case 'Not Started':
                return 'Not Started';
            default:
                return 'Unknown';
        }
    }

    function openModal() {
        document.getElementById('myModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('myModal').style.display = 'none';
    }

    function openUpdatePage() {
        // Extract game ID from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('id');

        // Redirect to update page with game ID as parameter
        window.location.href = `updateGame.html?id=${gameId}`;
    }

    async function deleteGame() {
        try {
            // Extract game ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('id');

            const response = await fetch(`http://localhost:8080/games/${gameId}`, {
                method: 'DELETE'
            });
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            // Optionally, redirect to another page after deletion
            window.location.href = 'gamesLibrary.html';
        } catch (error) {
            console.error('Error deleting game:', error);
            // Display error message or handle error as needed
        }
    }

    // Fetch game details when the page loads
    fetchGameDetails();
</script>

</body>
</html>
